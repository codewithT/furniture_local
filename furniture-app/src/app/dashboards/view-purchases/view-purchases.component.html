<div class="purchase-container">
  <!-- Loading indicator -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading purchases...</p>
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="error-container">
    <p class="error-message">{{ error }}</p>
    <button (click)="loadPurchases()" class="retry-btn">Retry</button>
  </div>
  
  <div class="header">
    <h1>Purchase Report</h1>
  </div>
  
  <div class="filter-toggle">
    <button (click)="toggleFilters()" class="toggle-filters-btn">
      {{ showFilters ? 'Hide Filters ▲' : 'Show Filters ▼' }}
    </button>
  </div>
  
  <!-- Filters section -->
  <div class="filters-section" *ngIf="showFilters">
    <h3>Purchase Filters</h3>
    <div class="filter-column-layout">
      <!-- SO Number -->
      <div class="filter-item">
        <label>SO Number:</label>
        <input 
            type="text" 
            [(ngModel)]="filters.SONumber" 
            placeholder="Enter SO Number"
            class="filter-input"
         >
      </div>
       
       <!-- Customer Expected Delivery Date -->
       <div class="filter-item">
         <label>Cust Exp Del Date:</label>
         <input 
            type="date" 
            [(ngModel)]="filters.Delivery_date" 
            class="filter-input"
        >
       </div>
      
      <!-- Pick Up Date -->
      <div class="filter-item">
        <label>Pick Up Date:</label>
        <input 
            type="date" 
            [(ngModel)]="filters.Supplier_Date" 
            class="filter-input"
        >
      </div>
      
      <!-- PO Number -->
      <div class="filter-item">
        <label>PO Number:</label>
        <input 
            type="text" 
            [(ngModel)]="filters.PONumber" 
            placeholder="Enter PO Number"
            class="filter-input"
        >
      </div>
      
      <!-- PO Status -->
      <div class="filter-item">
        <label>PO Status:</label>
        <select [(ngModel)]="filters.POStatus" class="filter-input">
          <option value="">All Status</option>
          <option value="Received">Received</option>
          <option value="Awaiting">Awaiting</option>
          <option value="Not Ordered">Not Ordered</option>
          <option value="PO created">PO created</option>
          <option value="Confirmed">Confirmed</option>
          <option value="Arriving Late">Arriving Late</option>
          <option value="Discontinued">Discontinued</option>
        </select>
      </div>
      
      <!-- PO Created Start Date -->
      <div class="filter-item">
        <label>PO Created From:</label>
        <input 
          type="date" 
          [(ngModel)]="filters.CreatedStartDate" 
          class="filter-input"
        />
      </div>

      <!-- PO Created End Date -->
      <div class="filter-item">
        <label>PO Created To:</label>
        <input 
          type="date" 
          [(ngModel)]="filters.CreatedEndDate" 
          class="filter-input"
        />
      </div>
    </div>

    <div class="filter-buttons">
      <button (click)="applyFilters()" class="apply-filters-btn">Apply Filters</button>
      <button (click)="clearFilters()" class="clear-filters-btn">Clear</button>
      <button (click)="exportToCsv()" class="apply-filters-btn" style="background: #17a2b8;">
        <span class="btn-icon">↓</span>
        Export Excel
      </button>
    </div>
  </div>

  <!-- Results info -->
  <div class="results-info">
    <p>Showing {{ getDisplayRange() }} entries</p>
  </div>

  <!-- Table container -->
  <div class="table-container" *ngIf="!loading && !error">
    <table>
      <thead>
        <tr>
          <th>Purchase ID</th>
          <th>SO Number</th>
          <th>Product Name</th>
          <th>CFE Product Code</th>
          <th>Cust Exp Del Date</th>
          <th>PO Status</th>
          <th>Delayed Date</th>
          <th>Pick Up Date</th>
          <th>PO Number</th>
          <th>Created By</th>
          <th>Created At</th>
          <th>Changed By</th>
          <th>Changed At</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let purchase of purchases; trackBy: trackByPurchaseId">
          <td>{{ purchase?.PurchaseID }}</td>
          <td>{{ purchase?.SONumber }}</td>
          <td>{{ purchase?.ProductName }}</td>
          <td>{{ purchase?.ProductCode }}</td>

          <!-- Customer Expected Delivery Date -->
          <td class="date-cell">
            <div class="date-display">
              <ng-container *ngIf="purchase?.Delivery_date; else tryDeliveryDate">
                {{ purchase.Delivery_date | utcToLocal:'date' }}
              </ng-container>
              <ng-template #tryDeliveryDate>
                <ng-container *ngIf="purchase?.Delivery_Date">
                  {{ purchase.Delivery_Date | utcToLocal:'date' }}
                </ng-container>
              </ng-template>
            </div>
          </td>
          
          <td>
            <span
              class="po-status-box"
              [ngClass]="{
                'status-received': purchase?.POStatus === 'Received',
                'status-awaiting': purchase?.POStatus === 'Awaiting',
                'status-not-ordered': purchase?.POStatus === 'Not Ordered',
                'status-po-created': purchase?.POStatus === 'PO created',
                'status-confirmed': purchase?.POStatus === 'Confirmed',
                'status-delayed': purchase?.POStatus === 'Arriving Late',
                'status-discontinued': purchase?.POStatus === 'Discontinued',
                'status-out-for-delivery': purchase?.POStatus === 'Out for Delivery',
                'status-delivered': purchase?.POStatus === 'Delivered'
              }"
            >
              {{ purchase?.POStatus }}
            </span>
          </td>

          <!-- Delayed Date -->
          <td class="date-cell">
            <div class="date-display" *ngIf="purchase?.Delayed_Date">
              {{ purchase.Delayed_Date | utcToLocal:'date' }}
            </div>
          </td>

          <!-- Pick Up Date (Supplier Date) -->
          <td class="date-cell">
            <div class="date-display" *ngIf="purchase?.Supplier_Date">
              {{ purchase.Supplier_Date | utcToLocal:'date' }}
            </div>
          </td>

          <td>{{ purchase?.PONumber }}</td>

          <!-- Created By -->
          <td>{{ purchase?.Created_by }}</td>
          
          <!-- Created At -->
          <td class="datetime-cell">
            <div class="datetime-display">
              <ng-container *ngIf="purchase?.CreatedAt; else useCreatedDatetime">
                {{ purchase.CreatedAt | utcToLocal:'datetime' }}
              </ng-container>
              <ng-template #useCreatedDatetime>
                <ng-container *ngIf="purchase?.Created_date">
                  {{ purchase.Created_date | utcToLocal:'date' }}
                  <span *ngIf="purchase?.Created_time" style="display: block; font-size: 0.9em; color: #666;">
                    {{ purchase.Created_time }}
                  </span>
                </ng-container>
              </ng-template>
            </div>
          </td>
          
          <!-- Changed By -->
          <td>{{ purchase?.Changed_by }}</td>
          
          <!-- Changed At -->
          <td class="datetime-cell">
            <div class="datetime-display">
              <ng-container *ngIf="purchase?.ChangedAt; else useChangedDatetime">
                {{ purchase.ChangedAt | utcToLocal:'datetime' }}
              </ng-container>
              <ng-template #useChangedDatetime>
                <ng-container *ngIf="purchase?.Changed_date">
                  {{ purchase.Changed_date | utcToLocal:'date' }}
                  <span *ngIf="purchase?.Changed_time" style="display: block; font-size: 0.9em; color: #666;">
                    {{ purchase.Changed_time }}
                  </span>
                </ng-container>
              </ng-template>
            </div>
          </td>
        </tr>

        <tr *ngIf="!purchases || purchases.length === 0">
          <td colspan="13" class="no-data">No purchases found</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Enhanced pagination controls -->
  <div class="pagination-wrapper" *ngIf="!loading && !error && totalRecords > 0">
    <div class="pagination-info">
      <div class="page-size-selector">
        <span>Show:</span>
        <select [(ngModel)]="pageSize" (change)="onPageSizeChange()">
          <option *ngFor="let size of pageSizeOptions" [value]="size">
            {{ size }} entries
          </option>
        </select>
      </div>
      
      <div class="record-count">
        {{ getDisplayRange() }}
      </div>
    </div>

    <div class="pagination-controls">
      <button
        [disabled]="currentPage <= 1"
        (click)="goToPage(1)"
        class="page-btn first-page"
        title="First Page"
      >
        ««
      </button>

      <button
        [disabled]="currentPage <= 1"
        (click)="previousPage()"
        class="page-btn prev-page"
        title="Previous Page"
      >
        ‹ Previous
      </button>

      <div class="page-numbers">
        <button
          *ngFor="let pageNum of getPageNumbers()"
          [class.active]="pageNum === currentPage"
          (click)="goToPage(pageNum)"
          class="page-number-btn"
        >
          {{ pageNum }}
        </button>
      </div>

      <button
        [disabled]="currentPage >= totalPages"
        (click)="nextPage()"
        class="page-btn next-page"
        title="Next Page"
      >
        Next ›
      </button>

      <button
        [disabled]="currentPage >= totalPages"
        (click)="goToPage(totalPages)"
        class="page-btn last-page"
        title="Last Page"
      >
        »»
      </button>
    </div>

    <div class="page-info">
      Page {{ currentPage }} of {{ totalPages }}
    </div>
  </div>
</div>

<style>
.date-cell, .datetime-cell {
  min-width: 120px;
}

.date-display, .datetime-display {
  font-weight: 500;
  margin-bottom: 2px;
}
</style>
