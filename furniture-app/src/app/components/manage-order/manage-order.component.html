<div class="cfe-container">
  <div class="cfe-header">
    <h2 class="cfe-animate-fade-in">Manage Orders</h2>
    <div class="cfe-search-container">
      <div class="cfe-search-box">
        <input
          type="text"
          class="cfe-search-input"
          [(ngModel)]="searchTerm"
          placeholder="Search by Product Name, Customer Email, SO Number"
          (input)="searchOrders()"
        />
      </div>
      
      <div class="cfe-button-group">
        <button class="cfe-btn-primary" (click)="sendEmailsToCustomers()">
          <i class="fas fa-envelope"></i>
          Send Email
        </button>
        
        <button class="cfe-btn-secondary" (click)="sendPaymentReminders()">
          <i class="fas fa-bell"></i>
          Send Payment Reminder
        </button>
      </div>
    </div>
  </div>

  <!-- Loading indicator -->
  <div *ngIf="isLoading" class="cfe-loading-container">
    <div class="cfe-spinner"></div>
    <p>Loading orders...</p>
  </div>
  
  <!-- Table container -->
  <div class="cfe-table-container" *ngIf="!isLoading">
    <table class="cfe-table">
      
      <thead>
        <tr>
          <th class="checkbox-column">
            <input 
              type="checkbox" 
              class="large-checkbox" 
              (change)="toggleSelectAll($event)"
            />
          </th>

          <th (click)="sortTable('SONumber')" [class.sorted]="isSortedBy('SONumber')">
            SO Number
            <span class="sort-icon">{{ getSortIcon('SONumber') }}</span>
          </th>

          <th (click)="sortTable('Created_date')" [class.sorted]="isSortedBy('Created_date')">
            Created Date
            <span class="sort-icon">{{ getSortIcon('Created_date') }}</span>
          </th>

          <th (click)="sortTable('ProductName')" [class.sorted]="isSortedBy('ProductName')">
            Product Name
            <span class="sort-icon">{{ getSortIcon('ProductName') }}</span>
          </th>
   
          <th (click)="sortTable('CustomerEmail')" [class.sorted]="isSortedBy('CustomerEmail')">
            Customer<br>Email
            <span class="sort-icon">{{ getSortIcon('CustomerEmail') }}</span>
          </th>

          <th (click)="sortTable('Customer_name')" [class.sorted]="isSortedBy('Customer_name')">
            Customer<br>Name
            <span class="sort-icon">{{ getSortIcon('Customer_name') }}</span>
          </th>

          <th (click)="sortTable('Qty')" [class.sorted]="isSortedBy('Qty')">
            Qty
            <span class="sort-icon">{{ getSortIcon('Qty') }}</span>
          </th>

          <th (click)="sortTable('Delivery_date')" [class.sorted]="isSortedBy('Delivery_date')">
            Delivery<br>Date
            <span class="sort-icon">{{ getSortIcon('Delivery_date') }}</span>
          </th>

          <th (click)="sortTable('SOStatus')" [class.sorted]="isSortedBy('SOStatus')">
            SO Status
            <span class="sort-icon">{{ getSortIcon('SOStatus') }}</span>
          </th>

          <th (click)="sortTable('Total_Paid_Amount')" [class.sorted]="isSortedBy('Total_Paid_Amount')">
            Total Paid Amount<br>per SO
            <span class="sort-icon">{{ getSortIcon('Total_Paid_Amount') }}</span>
          </th>

          <th (click)="sortTable('Payment_Status')" [class.sorted]="isSortedBy('Payment_Status')">
            Payment<br>Status
            <span class="sort-icon">{{ getSortIcon('Payment_Status') }}</span>
          </th>

          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let order of orders" class="clickable-row">
          <td class="checkbox-column">
            <input 
              type="checkbox" 
              class="large-checkbox" 
              [(ngModel)]="order.selected" 
            />
          </td>
          <td>{{ order.SONumber }}</td>
          <td>{{ order.Created_date | utcToLocal:'date' }}</td>
          <td [title]="order.ProductName">{{ order.ProductName }}</td>
          <td [title]="order.CustomerEmail">{{ order.CustomerEmail }}</td>
          <td [title]="order.Customer_name">{{ order.Customer_name }}</td>
          <td>{{ order.Qty }}</td>
          <td>{{ order.Delivery_date | utcToLocal:'date' }}</td>
          <td>{{ order.SOStatus }}</td>
          <td>{{ order.Total_Paid_Amount }}</td>
          <td class="payment-status-column">
            <select [(ngModel)]="order.Payment_Status" (change)="updatePaymentStatus(order)">
              <option value="Full Paid">Full Paid</option>
              <option value="Pending">Pending</option>
              <option value="Partial">Partial</option>
            </select>
          </td>
          <td class="actions">
            <div class="dropdown" [class.active]="order.dropdownOpen">
              <button class="dropdown-btn" type="button" (click)="toggleDropdown(order, $event)">
                Actions â–¼
              </button>
              <div class="dropdown-content" *ngIf="order.dropdownOpen">
                <button type="button" (click)="showSaleDetails(order); closeDropdown(order)">
                  <i class="fas fa-info-circle"></i> Complete Details
                </button>
                <button type="button" (click)="removeOrder(order); closeDropdown(order)">
                  <i class="fas fa-trash"></i> Remove
                </button>
              </div>
            </div>
          </td>
        </tr>
        <tr *ngIf="orders.length === 0">
          <td colspan="12" class="no-data">No orders found</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Custom Pagination -->
  <div class="pagination-controls" *ngIf="!isLoading">
    <div class="page-size-selector">
      <span>Show:</span>
      <select [(ngModel)]="pageSize" (change)="onPageSizeChange($event)">
        <option *ngFor="let size of pageSizeOptions" [value]="size">
          {{ size }} entries
        </option>
      </select>
    </div>

    <div class="pagination">
      <button
        [disabled]="currentPage <= 1"
        (click)="decrementPage()"
        class="page-btn"
      >
        <i class="fas fa-chevron-left"></i>
      </button>
      <span>Page {{ currentPage }} of {{ totalPages }}</span>
      <button
        [disabled]="currentPage >= totalPages"
        (click)="incrementPage()"
        class="page-btn"
      >
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
</div>